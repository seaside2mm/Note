## 对位姿

  
  

```c++

void EdgeSE3ProjectXYZOnlyPose::linearizeOplus() {

  VertexSE3Expmap *vi = static_cast<VertexSE3Expmap *>(_vertices[0]);

  Vector3 xyz_trans = vi->estimate().map(Xw);

  

  number_t x = xyz_trans[0];

  number_t y = xyz_trans[1];

  number_t invz = 1.0 / xyz_trans[2];

  number_t invz_2 = invz * invz;

  

  _jacobianOplusXi(0, 0) = x * y * invz_2 * fx;

  _jacobianOplusXi(0, 1) = -(1 + (x * x * invz_2)) * fx;

  _jacobianOplusXi(0, 2) = y * invz * fx;

  _jacobianOplusXi(0, 3) = -invz * fx;

  _jacobianOplusXi(0, 4) = 0;

  _jacobianOplusXi(0, 5) = x * invz_2 * fx;

  

  _jacobianOplusXi(1, 0) = (1 + y * y * invz_2) * fy;

  _jacobianOplusXi(1, 1) = -x * y * invz_2 * fy;

  _jacobianOplusXi(1, 2) = -x * invz * fy;

  _jacobianOplusXi(1, 3) = 0;

  _jacobianOplusXi(1, 4) = -invz * fy;

  _jacobianOplusXi(1, 5) = y * invz_2 * fy;

}

```

  
  
  

## 相机投影模型

  
  

相机坐标系下空间点$\mathbf{p}_{c}=[x_c,y_c,z_c]^\top\in \mathbb{R}^3$

投影到像平面点$\mathbf{p}_{I}=[u,v]^\top\in \mathbb{R}^2$

  

模型为，

$$

\begin{aligned}

\text{proj}(\mathbf{p}_{c})&=[\frac{1}{z_c}\mathbf{K}\mathbf{p}_{c}]_{1:2} \\

&= \begin{bmatrix}f_x & 0 & c_x \\ 0 & f_y & c_y \\ 0 & 0 & 1\end{bmatrix}\begin{bmatrix}x_c/z_c \\ y_c/z_c \\ 1 \end{bmatrix}_{1:2} \\

&= \begin{bmatrix}f_x*x_c/z_c+c_x \\ f_y*y_c/z_c+c_y \end{bmatrix}

\end{aligned}

$$

  
  

对空间点的雅克比为，

$$

\begin{aligned}

\frac{\partial \text{proj}(\mathbf{p}_{c})}{\partial \mathbf{p}_{c}}&= \begin{bmatrix}\frac{\partial u}{\partial x_c} & \frac{\partial u}{\partial y_c} & \frac{\partial u}{\partial z_c} \\ \frac{\partial v}{\partial x_c} & \frac{\partial v}{\partial y_c} & \frac{\partial v}{\partial z_c} \end{bmatrix}\\

&= \begin{bmatrix}f_x/z_c & 0 & -f_x*x_c/z_c^2 \\ 0 & f_y/z_c & -f_y*y_c/z_c^2 \end{bmatrix}

\end{aligned} \tag{5}

$$

  

## 立体视觉观测函数

  

相机坐标系下空间点$\mathbf{p}_{c}=[x_c,y_c,z_c]^\top\in \mathbb{R}^3$, 投影到左右相机平面, 另外由双目模型可知，

$u_l-u_r=\frac{bf_x}{z_c}$

  

可有，

$$

u_r=u_l-\frac{bf_x}{z_c}=f_x*x_c/z_c+c_x - \frac{bf_x}{z_c}

$$

  

对空间点的雅克比为，

$$

\begin{aligned}

\frac{\partial u_r}{\partial \mathbf{p}_{c}} &= \begin{bmatrix}\frac{\partial u_r}{\partial x_c} & \frac{\partial u_r}{\partial y_c} & \frac{\partial u_r}{\partial z_c} \end{bmatrix} \\

&= \begin{bmatrix}f_x/z_c & 0 & -f_x*(x_c-b)/z_c^2\end{bmatrix}

\end{aligned}

$$

  

与相机投影模型整合起来有,

$$

\begin{aligned}

\mathbf{z}_{stereo}&=\binom{\text{proj}(\mathbf{p}_{c})}{u_r} \\

&= \begin{bmatrix}f_x*x_c/z_c+c_x \\ f_y*y_c/z_c+c_y \\ f_x*x_c/z_c+c_x - \frac{bf_x}{z_c} \end{bmatrix}

\end{aligned}

$$

  

对空间点的雅克比为，

$$

\frac{\partial \mathbf{z}_{stereo}}{\partial \mathbf{p}_{c}} = \begin{bmatrix}f_x/z_c & 0 & -f_x*x_c/z_c^2 \\ 0 & f_y/z_c & -f_y*y_c/z_c^2 \\ f_x/z_c & 0 & -f_x*(x_c-b)/z_c^2\end{bmatrix} \tag{6}$$

  
  

## 位姿优化-单目重投影误差

位姿表示，

$$

\mathbf{T}_{cw}=\begin{bmatrix} \mathbf{R}_{cw} & \mathbf{t}_{cw} \\ 0^\top & 1 \end{bmatrix}=\text{exp}(\xi_0^\wedge ),\xi^\wedge_0\in{\mathfrak{se}(3)}

$$

误差为，

$$

\mathbf{e}_k(\xi)=\mathbf{p}_{I_k} - \text{proj}(\text{exp}(\xi^\wedge )\cdot\mathbf{p}_{w_k})

$$

  

在该初值的左扰动$\text{exp}(\epsilon^\wedge )$，对位姿的雅克比为，

$$

\begin{aligned}

\mathbf{J}_k=\frac{\partial \mathbf{e}_k}{\partial \epsilon}&= -\frac{\partial \text{proj}(\mathbf{p}_{c})}{\partial \mathbf{p}_{c}}\cdot \left.\begin{matrix} \frac{\partial \text{exp}(\epsilon^\wedge )\text{exp}(\xi^\wedge )\cdot\mathbf{p}_{w_k}}{\partial \epsilon}\end{matrix}\right|_{\epsilon=0}\\

&=-\begin{bmatrix}f_x/z_c & 0 & -f_x*x_c/z_c^2 \\ 0 & f_y/z_c & -f_y*y_c/z_c^2 \end{bmatrix} \cdot \begin{bmatrix}\mathbf{I}_{3\times 3} & -\mathbf{p}_c^\wedge\end{bmatrix}

\end{aligned}

$$

  

## 位姿优化-双目投影误差

  

$$

\mathbf{e}_k(\xi)=\begin{bmatrix}\mathbf{p}_{I_k} \\ u_r\end{bmatrix} - \mathbf{z}_{stereo}(\text{exp}(\xi^\wedge )\cdot\mathbf{p}_{w_k})

$$

  

对位姿的雅克比

$$

\begin{aligned}

\mathbf{J}_k=\frac{\partial \mathbf{e}_k}{\partial \epsilon} &= -\frac{\partial \mathbf{z}_{stereo}(\mathbf{p}_{c})}{\partial \mathbf{p}_{c}}\cdot \left.\begin{matrix} \frac{\partial \text{exp}(\epsilon^\wedge )\text{exp}(\xi^\wedge )\cdot\mathbf{p}_{w_k}}{\partial \epsilon}\end{matrix}\right|_{\epsilon=0} \\

&= -\begin{bmatrix}f_x/z_c & 0 & -f_x*x_c/z_c^2 \\ 0 & f_y/z_c & -f_y*y_c/z_c^2 \\ f_x/z_c & 0 & -f_x*(x_c-b)/z_c^2\end{bmatrix}\cdot \begin{bmatrix}\mathbf{I}_{3\times 3} & -\mathbf{p}_c^\wedge\end{bmatrix}

\end{aligned}

$$

  

## BA

优化位姿还需要优化空间点坐标

$$

\mathbf{e}_k(\xi)=\mathbf{p}_{I_k} - \text{proj}(\mathbf{T}_{cw}\cdot\mathbf{p}_{w_k})

$$

  

计算关于世界空间坐标点的导数

  

单目，

$$

\begin{aligned}

\mathbf{J}_k=\frac{\partial \mathbf{e}_k}{\partial \mathbf{p}_w} &= -\frac{\partial \text{proj}(\mathbf{p}_{c})}{\partial \mathbf{p}_c}\cdot \left.\begin{matrix} \frac{\partial (\mathbf{R}_{cw}\cdot\mathbf{p}_{w}+\mathbf{t}_{cw})}{\partial \mathbf{p}_{w}}\end{matrix}\right|_{\mathbf{p}_{w}=\mathbf{p}_{w_k}} \\

&=-\begin{bmatrix}f_x/z_c & 0 & -f_x*x_c/z_c^2 \\ 0 & f_y/z_c & -f_y*y_c/z_c^2 \end{bmatrix}\cdot \mathbf{R}_{cw}

\end{aligned}

$$

  
  
  

双目，

$$

\begin{aligned}

\mathbf{J}_k=\frac{\partial \mathbf{e}_k}{\partial \mathbf{p}_w} &= -\frac{\partial \mathbf{z}_{stereo}(\mathbf{p}_{c})}{\partial \mathbf{p}_c}\cdot \left.\begin{matrix} \frac{\partial (\mathbf{R}_{cw}\cdot\mathbf{p}_{w}+\mathbf{t}_{cw})}{\partial \mathbf{p}_{w}}\end{matrix}\right|_{\mathbf{p}_{w}=\mathbf{p}_{w_k}} \\

&=-\begin{bmatrix}f_x/z_c & 0 & -f_x*x_c/z_c^2 \\ 0 & f_y/z_c & -f_y*y_c/z_c^2 \\ f_x/z_c & 0 & -f_x*(x_c-b)/z_c^2\end{bmatrix}\cdot \mathbf{R}_{cw}

\end{aligned}

$$

  
  

## IMU预积分